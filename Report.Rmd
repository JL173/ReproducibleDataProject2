---
title: 'Project 2'
author: "JL"
date: "02/09/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Synopsis

Storms and other severe weather events can cause both public health and economic problems for communities and municipalities. Many severe events can result in fatalities, injuries, and property damage, and preventing such outcomes to the extent possible is a key concern.

########################### <- summary of findings here

```{r}
library(tidyverse)
library(ggplot2)
library(lubridate)
```

# Loading and Processing the Raw Data

This project involves exploring the U.S. National Oceanic and Atmospheric Administration's (NOAA) storm database. This database tracks characteristics of major storms and weather events in the United States, including when and where they occur, as well as estimates of any fatalities, injuries, and property damage.

```{r}
# Download data
download.file("https://d396qusza40orc.cloudfront.net/repdata%2Fdata%2FStormData.csv.bz2", "rawdata.csv.bz2")

# Download documentation for data
download.file("https://d396qusza40orc.cloudfront.net/repdata%2Fpeer2_doc%2Fpd01016005curr.pdf", "rawdata_documentation.pdf", mode = "wb")

# import data into dataframe
raw <- read.csv("rawdata.csv.bz2")
```

The events in the database start in the year 1950 and end in November 2011. In the earlier years of the database there are generally fewer events recorded, most likely due to a lack of good records. More recent years should be considered more complete.

## The Data

The dataframe `raw` has 37 columns and 900,000+ observations across the united states. Here is a brief overview.
```{r}
str(raw)
```

Information that we will explore are

- Location: STATE_, COUNTY, COUNTYNAME, STATE
- Time: BGN_DATE, BGN_TIME
- Event Information: EVTYPE, LENGTH, WIDTH, F, REMARKS
- Damage: FATALITIES, INJURIES, PROPDMG, PROPDMGEXP, CROPDMG, CROPDMGEXP

For LENGTH and WIDTH, this is the path length (in miles and tenths of miles) and maximum path width (in yards) for all tornadoes.

For F, The "Saffir-Simpson Hurricane and Tropical Cyclone Scale" is used

1. Windspeed 64-82 kts (74-95 mph), storm tide: 4-5 FT, Damage: Minor  
2. Windspeed 83-95 kts (96-110 mph), storm tide: 6-8 FT, Damage: Moderate  
3. Windspeed 96-113 kts (111-130 mph), storm tide: 9-12 FT, Damage: Major  
4. Windspeed 114-135 kts (131-155 mph), storm tide: 13-18 FT, Damage: Severe  
5. Windspeed >135 kts (>155 mph), storm tide: >18 FT, Damage: Catastrophic

For REMARKS, this is a description of the event.

For PROPDMGEXP and CROPDMGEXP, characters are used to signify cost of damage and include “K” for thousands, “M” for millions, and “B” for billions.

## Processing

To process the data for analysis, we will select only the variables that we have outlined above. Further, we will rename these variables to more accessible versions and ensure they are cast into the correct type for calculations. 

Secondly, we will create a dataframe for locations, containing both state and county ids with their respective state and county names, for reference.

```{r}
# collect location IDs for reference and remove duplicate rows
locations <- select(raw, "STATE__", "STATE", "COUNTY", "COUNTYNAME") %>%
  distinct(.keep_all = TRUE)

colnames(locations) <- c("state_id", "state_name", "county_id", "county_name")


# trim raw to chosen variables
raw <- select(raw, c("STATE__", "COUNTY", "BGN_DATE", "BGN_TIME", "EVTYPE", "LENGTH", "WIDTH", "F", "REMARKS", "FATALITIES", "INJURIES", "PROPDMG", "PROPDMGEXP", "CROPDMG", "CROPDMGEXP"))

# rename columns
colnames(raw) <- c("state_id", "county_id", "start_date", "start_time", "event", "length", "width", "F", "remarks", "fatalities", "injuries", "property_damage", "property_damage_cat", "crop_damage", "crop_damage_cat")

# cast raw into correct types and formats
raw$state_id <- as.integer(raw$state_id)
raw$county_id <- as.integer(raw$county_id)
raw$event <- as.factor(raw$event)
raw$F <- as.factor(raw$F)
raw$property_damage_cat <- as.factor(raw$property_damage_cat)
raw$crop_damage_cat <- as.factor(raw$crop_damage_cat)

raw$start_date <- as.Date(as.character(
  strptime(raw$start_date, format = "%m/%d/%Y")))
```

# Analysis

This first question we want ot investigate is the following

- Across the United States, which types of events are most harmful with respect to population health?

There are a few ways to interpret this. Direct harm, is easily fatalities and injuries, however indirectly we could have the economic impact such as property damage, or crop damage. So we will limit this to the direct harm.

We will group by event and summarise the data

```{r}
 direct_harm <- raw %>%
  group_by(event) %>%
  summarise(number_of_events = n(),
            total_fatalities = sum(fatalities),
            total_injuries = sum(injuries),
            total_sum = sum(fatalities) + sum(injuries)) %>%
  arrange(desc(total_sum))
```

Now we have the summarised data.

##### fill here

```{r}
# trim a copy of dataframe to top20, select key columns
dh_short <- direct_harm[1:20, ] %>%
  select(-c("mean_fatalities","mean_injuries"))
dh_short2 <- dh_short

# rename two columns to merge on
colnames(dh_short)[3] <- "Incidents"
colnames(dh_short2)[4] <- "Incidents"

# select only the columns we need for a merge
dh_short <- select(dh_short, c("event", "total_sum", "Incidents"))
dh_short2 <- select(dh_short2, c("event", "total_sum", "Incidents"))

# create a label to split data on plotting
dh_short$label <- "total_fatalities"
dh_short2$label <- "total_injuries"

# merge dataframes, remove the temprorary second
dh_short <- rbind(dh_short, dh_short2)
rm(dh_short2)
```

Now we have the data we need for plotting an informational visual in a way that allows us to create it easily.
```{r}

# plot for the top 20 by total of fatalities and injuries
ggplot(direct_harm[1:20, ]) + 
  
  geom_point(aes(x = total_fatalities,
                 y = reorder(event, total_sum)),
             size = 3, color = "#de425b", fill = "#de425b") +
 
   
  geom_point(aes(x = total_injuries,
                 y = reorder(event, total_sum)),
             size = 3, color = "#488f31", fill = "488f31") +
  
  labs(x = "Sum of Incidents",
       y = NULL,
       color = "Legend") +
  
  scale_color_manual(values = c("Fatalities" = "#de425b",
                                 "Injuries" = "#488f31")) +
  
  theme(
    plot.title = element_text(size = rel(1.2), lineheight = 0.9,
                               face = "bold", color = "brown"),
    panel.grid.major.x = element_blank(),
    panel.grid.minor.x = element_blank(),
    panel.grid.major.y = element_line(colour = "lightgrey", linetype = "dashed")
  ) + 
  
  scale_x_log10(breaks = c(1e1, 1e2, 1e3, 1e4, 1e5),
                labels = c("10", "100", "1,000", "10,000", "100,000")) +
  
  ggtitle("Total Fatalities and Injuries by Weather Events",
          subtitle = "United States 1950 - 2011")

```
```{r}
# another attempt at plotting to get a legend


```